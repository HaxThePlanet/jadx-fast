# P0-FOREACH-SEM: Empty For-Each Loop Body
**Status:** ✅ COMPLETED
**Agent:** Claude Opus 4.5
**Date:** Dec 25, 2025
**Fixed Date:** Dec 25, 2025

## Issue
For-each loops with if-return patterns produce empty loop bodies - the return statement is not emitted.

## Evidence (MaliciousPatterns.java lines 651-655)
```java
// DEXTERITY OUTPUT (WRONG):
for (String str : strArr) {
    if (new File(str).exists()) {
        // EMPTY! Return not emitted
    }
}
return z;  // Always returns initial false!

// JADX OUTPUT (CORRECT):
for (String str : strArr) {
    if (new File(str).exists()) {
        return true;  // Early return on match
    }
}
return false;
```

## Root Cause
The return block is **shared** between:
1. The if-body inside the for-each loop (early return)
2. The method's final return

```
// CFG structure:
Block 4 (if exists): goto Block 5
Block 5: return true
Block 6 (loop exit): return false  // or falls through to return true
```

When the return block is included in the if-body region, it gets marked as "already processed" or the codegen prevents duplicate emission.

## Technical Details

### Fixes Applied (Not Fully Effective)
1. **Successor Ordering** (region_builder.rs:1717-1729): Fixed then/else branch mapping based on `negate_condition`
2. **Fall-through Detection** (region_builder.rs:1949-1966): Extended to follow fall-through blocks, not just Goto chains

### Why It's Still Broken
The region structure correctly includes the return block in the if-body, but `generate_block()` checks if the block has already been emitted and skips it.

## Solution Implemented
**Approach:** Clone JADX's BlockProcessor.splitReturn() preprocessing pass

Port of JADX's solution which creates synthetic duplicate blocks for return blocks with 2+ predecessors.
This prevents shared blocks from ever appearing in the region tree - they're split at CFG level BEFORE region building.

### Implementation Details

**Files Modified:**
1. `crates/dexterity-passes/src/block_split.rs` - Added `split_return_blocks()` function (96 lines)
2. `crates/dexterity-passes/src/lib.rs` - Exported the new pass
3. `crates/dexterity-cli/src/decompiler.rs` - Registered pass in pipeline (Stage 1.5)

**How It Works:**
1. Find all blocks with Return instructions
2. For each return block with 2+ predecessors:
   - Mark first predecessor's block as ORIG_RETURN (using existing AFlag)
   - Create synthetic duplicate blocks for other predecessors (marked with AFlag::Synthetic)
   - Redirect each predecessor to its appropriate return block
3. This runs AFTER block splitting but BEFORE CFG construction

**Reference:**
- JADX: `BlockProcessor.splitReturn()` (lines 568-606)
- JADX: `BlockSplitter.java` for instruction copying patterns

### Test Results
- ✅ All 688+ unit tests pass
- ✅ Cargo check/build succeeds
- ✅ Code compiles without errors
