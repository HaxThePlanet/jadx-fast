# P1-LAMBDA-INLINING: Lambda Class Inlining
**Status:** MOSTLY WORKING
**Agent:** Claude Opus 4.5
**Date:** Dec 25, 2025

## Issue
Dexterity outputs lambda classes as separate files instead of inlining them at call sites like JADX.

**Current Output (before fix):**
```java
// Separate file: Lambda$1.java
list.forEach(new Lambda$1())
```

**JADX Output:**
```java
list.forEach(item -> process(item))
```

## JADX Reference
- `InsnGen.java:952-1090` - Lambda generation methods
  - `makeInvokeLambda()` (952-963)
  - `makeRefLambda()` (965-983)
  - `makeSimpleLambda()` (985-1030)
  - `makeInlinedLambdaMethod()` (1032-1090)
- `CustomLambdaCall.java:97-102` - DONT_GENERATE flag

## Current State (Dec 25, 2025)

### Working âœ…
- **Variable assignment**: `Function obj = str -> { ... };` âœ…
- **Method reference syntax**: `out2::println` âœ…
- **SAM interface type inference**: `Function`, `Consumer`, `Supplier` âœ…
- **Lambda parameter generation**: `o -> { ... }` âœ…
- **Supplier body inlining**: `() -> { String r0 = "hello"; return r0; }` âœ…

### Partially Working ðŸ”¶
- **Lambda body method calls**: Emits method calls but doesn't chain results correctly
  - Current: `Integer.parseInt(o); Integer.valueOf(o); return o;`
  - Expected: `return Integer.valueOf(Integer.parseInt(str));`
  - Root cause: MoveResult not merged with Invoke inside lambda methods

### Test Results
Tested with Java 8 lambdas compiled with `d8 --no-desugaring --min-api 26`:
- Most Play Store APKs use desugaring (no invoke-custom)
- Custom test with invoke-custom shows infrastructure works

## Fixes Applied (Dec 25, 2025)

1. **InvokeCustom destination handling** (body_gen.rs:11493-11545)
   - Was ignoring `dest` register (using `dest: _`)
   - Now properly emits: `Type varName = lambda_expression;`

2. **SAM interface type inference** (instructions.rs:1254-1286)
   - Added `get_sam_interface_simple_name()` method to LambdaInfo
   - Maps method names to interface types: applyâ†’Function, acceptâ†’Consumer, etc.

3. **Lambda body instruction handling** (body_gen.rs:6511-6592)
   - Extended `generate_lambda_insn_with_mapping()` to handle:
     - `Invoke` instructions with proper class/method names
     - `ConstString` instructions
     - `Return` instructions with variable mapping

## Remaining Work
- Chain method call results properly in lambda body (MoveResult handling)
- Fix class name truncation issue (`ambdaTest` vs `LambdaTest`)
- Test with more real-world APKs containing invoke-custom

## Files Modified
- `crates/dexterity-codegen/src/body_gen.rs` (InvokeCustom handler, lambda body generation)
- `crates/dexterity-ir/src/instructions.rs` (LambdaInfo SAM type inference)
