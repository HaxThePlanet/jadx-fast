STRINGBUILDER_CONCAT: StringBuilder Chain to String Concatenation
==================================================================

Claimed: Dec 22, 2025
Status: BLOCKED - Needs IR-level implementation
Agent: Claude Opus 4.5

Issue Description:
------------------
Port JADX's SimplifyVisitor StringBuilder chain simplification to convert:
  `new StringBuilder("a").append(b).append("c").toString()`  ->  `"a" + b + "c"`

Investigation Results:
----------------------
1. The current codegen-level implementation is broken because:
   - P1-S10 fix merged invoke+move_result, so chain transfer via MoveResult no longer works
   - Attempted fix to handle merged dest field in Invoke instructions
   - But NewInstance + <init> pairing fails due to SSA register renaming
   - The pending_new_instances tracking doesn't match receiver registers after SSA

2. Root cause analysis:
   - NewInstance creates object in register X
   - After SSA, <init> receives a DIFFERENT SSA-versioned register
   - The reg_num-based tracking doesn't work with SSA versions
   - Framework class methods (java.lang.StringBuilder) may go through different code paths

3. JADX approach (correct):
   - Detects StringBuilder chains at IR level BEFORE codegen
   - Works on raw instructions before SSA transformation
   - Creates STR_CONCAT instruction to replace the whole chain
   - This is more robust than codegen-level string parsing

Recommended Fix:
----------------
Port JADX's approach to work at IR level:
1. Add detection in process_instructions.rs (runs before SSA)
2. Detect new-instance + <init> + append* + toString pattern
3. Replace entire chain with StrConcat instruction
4. Codegen already handles StrConcat (line 8070+)

Files to Modify:
- crates/dexterity-passes/src/process_instructions.rs (or new simplify_stringbuilder.rs)
- Detect and transform before SSA transformation

Current Workaround:
-------------------
The output is still valid Java code, just not as clean as JADX:
- JADX: `return "a" + b + "c";`
- Dexterity: `StringBuilder sb = new StringBuilder(); sb.append("a"); ...; return sb.toString();`

Progress Log:
-------------
Dec 22, 2025 - Claimed, investigated issue
Dec 22, 2025 - Found root cause: SSA register renaming breaks pending_new_instances tracking
Dec 22, 2025 - Recommended: Move detection to IR level before SSA (like JADX)
